<!doctype html>
<html lang="en-US">

<head>
  <meta charset="utf-8" />
  <title>Password checking with YPIR</title>
  <style>
    .bad {
      color: red;
      font-weight: bold;
    }

    .good {
      color: green;
    }
  </style>
</head>

<body>
  <h2>Password checker</h2>
  <p>
    Use YPIR to private check whether a password has previously appeared in the
    <a href="https://haveibeenpwned.com/Passwords">Have I Been Pwned</a>
    database of ~1 billion breached passwords.
  </p>
  <input type="text" id="password" />
  <button type="button" id="submit">&gt;</button>
  <br />
  <p id="output"></p>

  <script type="module">
    import { init, generateQueryToCheckItemInclusion, decodeResponseToInclusionQuery, postRequest } from "../js/index.js";
    function performQuery() {
      const output = document.getElementById("output");
      const password = document.getElementById("password");
      const submit = document.getElementById("submit");

      submit.disabled = true;
      submit.innerText = "...";
      setTimeout(() => {
        const targetItem = password.value;
        const { query, seed } = generateQueryToCheckItemInclusion(targetItem);
        postRequest("http://localhost:8989/query", query).then((response) => {
          const found = decodeResponseToInclusionQuery(response, seed, targetItem);
          output.innerText =
            found ? "Password found in prior breach!" : "Password not found in the HIBP database of ~1B breached credentials.";
          output.classList.remove("good", "bad");
          output.classList.add(found ? "bad" : "good");
          submit.disabled = false;
          submit.innerText = ">";
        });
      }, 1);
    }
    init().then(() => {
      const password = document.getElementById("password");
      const submit = document.getElementById("submit");
      submit.addEventListener("click", performQuery);
      password.onkeydown = function (e) {
        if (e.keyCode == 13 && !submit.disabled) {
          performQuery();
        }
      };
    });
  </script>
</body>

</html>